<script>
function handleChangePassword() {
  const userData = JSON.parse(sessionStorage.getItem('userData'));
  const params = new URLSearchParams({
    action: 'updatePassword',
    phone: userData.phone,
    currentPassword: document.getElementById('currentPassword').value,
    newPassword: document.getElementById('newPassword').value,
    confirmPassword: document.getElementById('confirmPassword').value,
    callback: `jsonp_${Date.now()}`
  });

  const script = document.createElement('script');
  script.src = `${CONFIG.GAS_URL}?${params}`;
  
  window[params.get('callback')] = response => {
    if (response.success) {
      alert('Password changed! Logging out...');
      handleLogout();
    } else {
      showError(response.message);
    }
  };
  document.body.appendChild(script);
}

function handleChangeEmail() {
  const userData = JSON.parse(sessionStorage.getItem('userData'));
  const params = new URLSearchParams({
    action: 'updateEmail',
    phone: userData.phone,
    currentPassword: document.getElementById('verifyPassword').value,
    newEmail: document.getElementById('newEmail').value,
    confirmEmail: document.getElementById('confirmEmail').value,
    callback: `jsonp_${Date.now()}`
  });

  const script = document.createElement('script');
  script.src = `${CONFIG.GAS_URL}?${params}`;
  
  window[params.get('callback')] = response => {
    if (response.success) {
      userData.email = document.getElementById('newEmail').value;
      sessionStorage.setItem('userData', JSON.stringify(userData));
      alert('Email updated!');
      safeRedirect('dashboard.html');
    } else {
      showError(response.message);
    }
  };
  document.body.appendChild(script);
}
</script>
