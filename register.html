<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Register - Cahaya Az Zahra Enterprise</title>
  <link rel="stylesheet" href="styles/main.css">
  <style>
    .registration-page {
      max-width: 500px;
      animation: slideUp 0.3s ease-out;
    }

    .password-rules {
      font-size: 0.8em;
      color: var(--gold);
      margin: 5px 0 10px;
      opacity: 0.8;
    }

    .loader {
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--gold);
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 480px) {
      .registration-page {
        padding: 15px;
      }
      
      input {
        padding: 10px;
        font-size: 14px;
      }
      
      button {
        padding: 10px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container registration-page">
    <h1>New Registration</h1>
    
    <div class="input-group">
      <input type="tel" 
             id="regPhone" 
             placeholder="Phone (673/60 format)" 
             pattern="^(673\d{7,}|60\d{9,})$" 
             required>
      <div class="error-message" id="phoneError"></div>
    </div>

    <div class="input-group">
      <input type="password" 
             id="regPassword" 
             placeholder="Create Password"
             pattern="^(?=.*[A-Z])(?=.*\d).{6,}$" 
             required>
      <div class="password-rules">6+ characters, 1 uppercase, 1 number</div>
      <div class="error-message" id="passError"></div>
    </div>

    <div class="input-group">
      <input type="password" 
             id="regConfirmPass" 
             placeholder="Confirm Password" 
             required>
      <div class="error-message" id="confirmPassError"></div>
    </div>

    <div class="input-group">
      <input type="email" 
             id="regEmail" 
             placeholder="Email Address" 
             required>
      <div class="error-message" id="emailError"></div>
    </div>

    <div class="input-group">
      <input type="email" 
             id="regConfirmEmail" 
             placeholder="Confirm Email" 
             required>
      <div class="error-message" id="confirmEmailError"></div>
    </div>

    <button id="registerBtn" onclick="handleRegistration(event)">
      Create Account
    </button>
    <button class="secondary-btn" 
            onclick="safeRedirect('login.html')" 
            style="margin-top: 10px;">
      Back to Login
    </button>

    <div id="registrationStatus" class="status-message" style="display: none;"></div>
  </div>

  <script src="scripts/app.js"></script>
  <script>
    // Enhanced registration handler with CORS fixes
    async function handleRegistration(event) {
      event.preventDefault();
      
      // Clear previous errors
      document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
      const statusElement = document.getElementById('registrationStatus');
      statusElement.style.display = 'none';

      if (!validateRegistrationForm()) return;

      const btn = document.getElementById('registerBtn');
      const originalBtnText = btn.innerHTML;
      
      try {
        // Show loading state
        btn.disabled = true;
        btn.innerHTML = '<div class="loader"></div> Registering...';

        const formData = {
          phone: document.getElementById('regPhone').value,
          password: document.getElementById('regPassword').value,
          email: document.getElementById('regEmail').value
        };

        // Direct POST request with CORS headers
        const response = await fetch(CONFIG.GAS_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            action: 'createAccount',
            ...formData
          }),
          referrerPolicy: 'strict-origin-when-cross-origin'
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const result = await response.json();

        if (result.success) {
          statusElement.className = 'status-message success';
          statusElement.textContent = 'Registration successful! Redirecting...';
          statusElement.style.display = 'block';
          
          setTimeout(() => safeRedirect('login.html'), 1500);
        } else {
          throw new Error(result.message || 'Registration failed');
        }
      } catch (error) {
        statusElement.className = 'status-message error';
        statusElement.textContent = `Error: ${error.message}`;
        statusElement.style.display = 'block';
        console.error('Registration error:', error);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
      }
    }

    // Real-time validation
    document.getElementById('regPhone').addEventListener('input', function() {
      document.getElementById('phoneError').textContent = 
        !validatePhone(this.value) ? 'Invalid phone format' : '';
    });

    document.getElementById('regPassword').addEventListener('input', function() {
      document.getElementById('passError').textContent = 
        !validatePassword(this.value) ? '6+ chars, 1 uppercase, 1 number' : '';
    });

    document.getElementById('regConfirmPass').addEventListener('input', function() {
      document.getElementById('confirmPassError').textContent = 
        this.value !== document.getElementById('regPassword').value ? 'Passwords mismatch' : '';
    });

    document.getElementById('regEmail').addEventListener('input', function() {
      document.getElementById('emailError').textContent = 
        !validateEmail(this.value) ? 'Invalid email format' : '';
    });

    document.getElementById('regConfirmEmail').addEventListener('input', function() {
      document.getElementById('confirmEmailError').textContent = 
        this.value !== document.getElementById('regEmail').value ? 'Emails mismatch' : '';
    });

    // Configuration check
    document.addEventListener('DOMContentLoaded', () => {
      if (!CONFIG?.GAS_URL.includes('https://')) {
        const statusElement = document.getElementById('registrationStatus');
        statusElement.className = 'status-message error';
        statusElement.textContent = 'System configuration error - please contact support';
        statusElement.style.display = 'block';
      }
    });
  </script>
</body>
</html>
